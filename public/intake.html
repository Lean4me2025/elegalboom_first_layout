<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ElegalBoom — LLC Formation Intake</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700;900&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --surface:#ffffff; --muted:#6b7280; --text:#0b132b; --brand:#0a66c2; --accent:#d23f57; --radius:14px; --shadow:0 14px 34px rgba(0,0,0,.12); }
    *{box-sizing:border-box} body{margin:0;background:#f7f8fb;color:var(--text);font-family: Inter, ui-sans-serif, system-ui}
    .container{max-width:1000px;margin:24px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand .dot{width:36px;height:36px;border-radius:50%;background:#0f1115;color:#fff;display:grid;place-items:center}
    h1{font-family:Merriweather, Georgia, serif;font-weight:900;margin:0 0 8px}
    .subtitle{color:var(--muted);margin-bottom:18px}
    .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
    .section+ .section{margin-top:18px} .section h2{margin:0 0 6px} .help{color:var(--muted);font-size:.95em;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px} @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    label{font-weight:600;display:block;margin:6px 0}
    input,select,textarea{width:100%;padding:12px;border:1px solid #d6d8df;border-radius:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(10,102,194,.1)}
    .progress{height:8px;background:#e6e8ee;border-radius:999px;overflow:hidden;margin:8px 0 18px}
    .bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--accent));width:25%;transition:width .3s ease}
    .btnRow{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
    .btn{border:0;border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:800}
    .btn.secondary{background:#eef2f7;color:#0b132b} .btn.primary{background:var(--brand);color:#fff} .btn.primary:disabled{opacity:.5;cursor:not-allowed}
    .hidden{display:none} .pillNote{display:inline-block;background:#f3f4f6;color:#374151;padding:6px 10px;border-radius:999px;font-size:.9em;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><div class="dot">EB</div> ElegalBoom</div>
      <div class="pillNote">Secure • State‑Aware • Stripe Checkout</div>
    </header>

    <div class="card">
      <h1>LLC Formation — Intake</h1>
      <p class="subtitle">Tell us about your company. We’ll adapt the questions to your state automatically.</p>
      <div class="progress"><div class="bar" id="progressBar" style="width:25%"></div></div>

      <section class="section" id="step1">
        <h2>Company Basics</h2>
        <p class="help">Start with your company name and formation state.</p>
        <div class="grid">
          <div><label>LLC Name <input name="llc_name" required /></label></div>
          <div>
            <label>Formation State
              <select name="state" id="stateSelect" required>
                <option value="">Select…</option>
                <option value="DE">Delaware</option>
                <option value="TX">Texas</option>
                <option value="PA">Pennsylvania</option>
                <option value="CA">California</option>
                <option value="NY">New York</option>
                <option value="AZ">Arizona</option>
                <option value="FL">Florida</option>
                <option value="OH">Ohio</option>
                <option value="GA">Georgia</option>
                <option value="IL">Illinois</option>
                <option value="WA">Washington</option>
              </select>
            </label>
          </div>
          <div style="grid-column:1/-1"><label>Principal Office Address <textarea name="principal_address" rows="2" required></textarea></label></div>
          <div><label>Registered Agent Name <input name="registered_agent_name" required /></label></div>
          <div><label>Registered Agent Address <textarea name="registered_agent_address" rows="2" required></textarea></label></div>
          <div><label>Organizer Name <input name="organizer_name" required /></label></div>
          <div><label>Organizer Address <textarea name="organizer_address" rows="2" required></textarea></label></div>
          <div><label>Effective Date <input type="date" name="effective_date" required /></label></div>
          <div>
            <label>Management Structure
              <select name="management_type" required>
                <option value="">Select…</option>
                <option>MEMBER-MANAGED</option>
                <option>MANAGER-MANAGED</option>
              </select>
            </label>
          </div>
        </div>
        <div class="btnRow"><button class="btn primary" id="toStep2">Next: Members</button></div>
      </section>

      <section class="section hidden" id="step2">
        <h2>Members / Managers</h2>
        <p class="help">Add ownership details. You can add more members later.</p>
        <div class="grid">
          <div><label>Member 1 Name <input name="member1_name" required /></label></div>
          <div><label>Member 1 Ownership % <input type="number" name="member1_pct" min="0" max="100" required /></label></div>
          <div><label>Member 2 Name <input name="member2_name" /></label></div>
          <div><label>Member 2 Ownership % <input type="number" name="member2_pct" min="0" max="100" /></label></div>
        </div>
        <div class="btnRow"><button class="btn secondary" id="back1">Back</button><button class="btn primary" id="toStep3">Next: State Requirements</button></div>
      </section>

      <section class="section hidden" id="step3">
        <h2>Additional State Requirements</h2>
        <p class="help" id="stateHelp">These questions appear only if required by your state.</p>
        <div id="extrasContainer"></div>
        <p class="help" id="stateNotes"></p>
        <div class="btnRow"><button class="btn secondary" id="back2">Back</button><button class="btn primary" id="reviewBtn">Review & Continue</button></div>
      </section>

      <section class="section hidden" id="step4">
        <h2>Review</h2>
        <p class="help">Confirm your details before checkout.</p>
        <pre id="reviewBox" style="background:#0f111508;border:1px solid #e5e7eb;border-radius:10px;padding:12px;white-space:pre-wrap"></pre>
        <div class="btnRow"><button class="btn secondary" id="back3">Back</button><button class="btn primary" id="checkoutBtn">Continue to Checkout</button></div>
      </section>
    </div>
  </div>

  <script>
    const bar = document.getElementById('progressBar');
    function setProgress(step){ bar.style.width = (step*25) + '%'; }
    const step1=document.getElementById('step1'); const step2=document.getElementById('step2'); const step3=document.getElementById('step3'); const step4=document.getElementById('step4');
    document.getElementById('toStep2').onclick=()=>{step1.classList.add('hidden'); step2.classList.remove('hidden'); setProgress(2);} 
    document.getElementById('back1').onclick =()=>{step2.classList.add('hidden'); step1.classList.remove('hidden'); setProgress(1);} 
    document.getElementById('toStep3').onclick=()=>{step2.classList.add('hidden'); step3.classList.remove('hidden'); setProgress(3); renderExtras();}
    document.getElementById('back2').onclick =()=>{step3.classList.add('hidden'); step2.classList.remove('hidden'); setProgress(2);} 
    document.getElementById('back3').onclick =()=>{step4.classList.add('hidden'); step3.classList.remove('hidden'); setProgress(3);} 

    const extrasContainer=document.getElementById('extrasContainer'); const stateNotes=document.getElementById('stateNotes'); const stateSelect=document.getElementById('stateSelect'); let overrides={};
    fetch('/config/state_overrides.json').then(r=>r.json()).then(j=>overrides=j).catch(()=>overrides={});

    function renderExtras(){
      const st=(stateSelect.value||'').toUpperCase(); const cfg=overrides[st];
      extrasContainer.innerHTML=''; stateNotes.textContent='';
      if(!cfg){ stateNotes.textContent='No additional questions required for your state.'; return; }
      (cfg.extraFields||[]).forEach(f=>{
        const wrap=document.createElement('div'); wrap.style.marginBottom='12px';
        const label=document.createElement('label'); label.textContent=f.label + (f.required?' *':''); label.style.display='block'; label.style.fontWeight='600'; label.style.marginBottom='6px';
        let input;
        if(f.type==='textarea'){ input=document.createElement('textarea'); input.rows=2; }
        else if(f.type==='select'){ input=document.createElement('select'); input.appendChild(new Option('Select…','')); (f.options||[]).forEach(opt=> input.appendChild(new Option(opt,opt))); }
        else { input=document.createElement('input'); input.type=f.type || 'text'; if(f.min!==undefined) input.min=f.min; if(f.max!==undefined) input.max=f.max; if(f.pattern) input.pattern=f.pattern; }
        input.name=f.id; if(f.required) input.required=true;
        if(f.showIf){ wrap.dataset.showIf=JSON.stringify(f.showIf); wrap.style.display='none'; }
        wrap.appendChild(label); wrap.appendChild(input); extrasContainer.appendChild(wrap);
      });
      if(cfg.notes) stateNotes.textContent=cfg.notes; bindConditionalVisibility();
    }

    function bindConditionalVisibility(){
      [...extrasContainer.querySelectorAll('[data-show-if]')].forEach(wrap=>{
        const rule=JSON.parse(wrap.dataset.showIf); const controller=extrasContainer.querySelector(`[name="${rule.field}"]`);
        const evalRule=()=>{ const val=controller?.value || ''; wrap.style.display=(val===String(rule.equals))?'':'none'; if(wrap.style.display==='none'){ const input=wrap.querySelector('input,select,textarea'); if(input) input.value=''; } };
        controller?.addEventListener('change', evalRule); evalRule();
      });
    }

    document.getElementById('reviewBtn').onclick=()=>{ const data=collectData(); document.getElementById('reviewBox').textContent=JSON.stringify(data,null,2); step3.classList.add('hidden'); step4.classList.remove('hidden'); setProgress(4); };

    document.getElementById('checkoutBtn').onclick=async()=>{
      const answers=collectData();
      const draftRes=await fetch('/api/save-intake',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product:'llc',answers})}).catch(()=>null);
      const draft=draftRes?await draftRes.json():{draftId:'draft_local'};
      const sessionRes=await fetch('/api/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product:'llc',draftId:draft.draftId})}).catch(()=>null);
      const session=sessionRes?await sessionRes.json():{id:null};
      if(session && session.id){ const s=await loadStripe(); s.redirectToCheckout({sessionId:session.id}); } else { alert('Checkout not configured yet, but your intake was captured.'); }
    };

    function collectData(){ const data={}; document.querySelectorAll('input,select,textarea').forEach(el=>{ if(!el.name) return; if(el.closest('#step3') && el.closest('#step3').classList.contains('hidden')) return; data[el.name]=el.value; }); return data; }

    async function loadStripe(){ if(window.Stripe) return window.Stripe('pk_live_YOUR_PUBLISHABLE_KEY'); return new Promise(resolve=>{ const s=document.createElement('script'); s.src='https://js.stripe.com/v3/'; s.onload=()=>resolve(window.Stripe('pk_live_YOUR_PUBLISHABLE_KEY')); document.head.appendChild(s); }); }
  </script>
</body>
</html>
