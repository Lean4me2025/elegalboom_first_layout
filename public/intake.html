<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ElegalBoom — LLC Intake</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 900px; margin: 24px auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    .section { padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin: 16px 0; }
    .muted { color:#6b7280; font-size: 0.9em; }
    .hidden { display:none; }
    .btn { background:#0a66c2; color:#fff; border:none; padding:12px 18px; border-radius:8px; font-weight:700; cursor:pointer; }
  </style>
</head>
<body>
  <h1>LLC Formation — Intake</h1>

  <div class="section">
    <h2>Company Basics</h2>
    <div class="grid">
      <div><label>LLC Name<input name="llc_name" required></label></div>
      <div>
        <label>Formation State
          <select name="state" id="stateSelect" required>
            <option value="">Select…</option>
            <option value="DE">Delaware</option>
            <option value="NV">Nevada</option>
            <option value="FL">Florida</option>
            <option value="TX">Texas</option>
            <option value="PA">Pennsylvania</option>
            <option value="CA">California</option>
            <option value="NY">New York</option>
            <option value="AZ">Arizona</option>
            <option value="OH">Ohio</option>
            <option value="GA">Georgia</option>
            <option value="IL">Illinois</option>
            <option value="WA">Washington</option>
            <option value="OR">Oregon</option>
            <option value="NC">North Carolina</option>
            <option value="MI">Michigan</option>
          </select>
        </label>
      </div>
      <div class="grid" style="grid-column:1 / -1;">
        <div><label>Principal Office Address<textarea name="principal_address" rows="2" required></textarea></label></div>
      </div>
      <div><label>Registered Agent Name<input name="registered_agent_name" required></label></div>
      <div><label>Registered Agent Address<textarea name="registered_agent_address" rows="2" required></textarea></label></div>
      <div><label>Organizer Name<input name="organizer_name" required></label></div>
      <div><label>Organizer Address<textarea name="organizer_address" rows="2" required></textarea></label></div>
      <div><label>Effective Date<input type="date" name="effective_date" required></label></div>
      <div>
        <label>Management Structure
          <select name="management_type" required>
            <option value="">Select…</option>
            <option>MEMBER-MANAGED</option>
            <option>MANAGER-MANAGED</option>
          </select>
        </label>
      </div>
    </div>
    <p class="muted">We’ll ask for member/manager details next.</p>
  </div>

  <div class="section">
    <h2>Members / Managers</h2>
    <div class="grid">
      <div><label>Member 1 Name<input name="member1_name" required></label></div>
      <div><label>Member 1 Ownership %<input type="number" min="0" max="100" name="member1_pct" required></label></div>
      <div><label>Member 2 Name<input name="member2_name"></label></div>
      <div><label>Member 2 Ownership %<input type="number" min="0" max="100" name="member2_pct"></label></div>
    </div>
  </div>

  <div class="section hidden" id="stateExtras">
    <h2 id="stateExtrasTitle">Additional State Requirements</h2>
    <div id="extrasContainer"></div>
    <p class="muted" id="stateNotes"></p>
  </div>

  <div class="section">
    <button class="btn" id="continueBtn">Continue to Checkout</button>
  </div>

  <script>
    const USPS = {"AL":"Alabama","AK":"Alaska","AZ":"Arizona","AR":"Arkansas","CA":"California","CO":"Colorado","CT":"Connecticut","DE":"Delaware","FL":"Florida","GA":"Georgia","HI":"Hawaii","ID":"Idaho","IL":"Illinois","IN":"Indiana","IA":"Iowa","KS":"Kansas","KY":"Kentucky","LA":"Louisiana","ME":"Maine","MD":"Maryland","MA":"Massachusetts","MI":"Michigan","MN":"Minnesota","MS":"Mississippi","MO":"Missouri","MT":"Montana","NE":"Nebraska","NV":"Nevada","NH":"New Hampshire","NJ":"New Jersey","NM":"New Mexico","NY":"New York","NC":"North Carolina","ND":"North Dakota","OH":"Ohio","OK":"Oklahoma","OR":"Oregon","PA":"Pennsylvania","RI":"Rhode Island","SC":"South Carolina","SD":"South Dakota","TN":"Tennessee","TX":"Texas","UT":"Utah","VT":"Vermont","VA":"Virginia","WA":"Washington","WV":"West Virginia","WI":"Wisconsin","WY":"Wyoming","DC":"District of Columbia"};

    let overrides = {};
    fetch('/config/state_overrides.json').then(r => r.json()).then(json => overrides = json).catch(()=>{});

    const stateSelect = document.getElementById('stateSelect');
    const extrasSection = document.getElementById('stateExtras');
    const extrasTitle = document.getElementById('stateExtrasTitle');
    const extrasContainer = document.getElementById('extrasContainer');
    const stateNotes = document.getElementById('stateNotes');

    function renderExtras(state) {
      const cfg = overrides[state];
      extrasContainer.innerHTML = '';
      stateNotes.textContent = '';
      if (!cfg) { extrasSection.classList.add('hidden'); return; }

      extrasTitle.textContent = `Additional State Requirements — ${cfg.label}`;
      if (cfg.notes) stateNotes.textContent = cfg.notes;

      (cfg.extraFields || []).forEach(f => {
        const wrap = document.createElement('div');
        wrap.style.marginBottom = '12px';

        const label = document.createElement('label');
        label.textContent = f.label + (f.required ? ' *' : '');
        label.style.display = 'block';
        label.style.fontWeight = '600';
        label.style.marginBottom = '6px';

        let input;
        if (f.type === 'textarea') {
          input = document.createElement('textarea'); input.rows = 2;
        } else if (f.type === 'select') {
          input = document.createElement('select');
          input.appendChild(new Option('Select…',''));
          (f.options || []).forEach(opt => input.appendChild(new Option(opt,opt)));
        } else {
          input = document.createElement('input');
          input.type = f.type || 'text';
          if (f.min !== undefined) input.min = f.min;
          if (f.max !== undefined) input.max = f.max;
          if (f.pattern) input.pattern = f.pattern;
        }
        input.name = f.id;
        if (f.required) input.required = true;

        if (f.showIf) {
          wrap.dataset.showIf = JSON.stringify(f.showIf);
          wrap.style.display = 'none';
        }

        wrap.appendChild(label);
        wrap.appendChild(input);
        extrasContainer.appendChild(wrap);
      });

      extrasSection.classList.remove('hidden');
      bindConditionalVisibility();
    }

    function bindConditionalVisibility() {
      [...extrasContainer.querySelectorAll('[data-show-if]')].forEach(wrap => {
        const rule = JSON.parse(wrap.dataset.showIf);
        const controller = extrasContainer.querySelector(`[name="${rule.field}"]`);
        function evalRule() {
          const val = controller?.value || '';
          wrap.style.display = (val === String(rule.equals)) ? '' : 'none';
          if (wrap.style.display === 'none') {
            const input = wrap.querySelector('input,select,textarea');
            if (input) { input.value = ''; }
          }
        }
        controller?.addEventListener('change', evalRule);
        evalRule();
      });
    }

    const addr = document.querySelector('[name="principal_address"]');
    addr.addEventListener('blur', () => {
      const m = addr.value.match(/[,\s]([A-Z]{2})\s+\d{5}(?:-\d{4})?$/i);
      if (m) {
        const abbr = m[1].toUpperCase();
        if (USPS[abbr] && !stateSelect.value) {
          stateSelect.value = abbr;
          renderExtras(abbr);
        }
      }
    });

    stateSelect.addEventListener('change', () => renderExtras(stateSelect.value));

    document.getElementById('continueBtn').addEventListener('click', async () => {
      const formEl = document.body;
      const data = {};
      formEl.querySelectorAll('input,select,textarea').forEach(el => {
        if (!el.name) return;
        if (el.closest('#stateExtras') && el.closest('#stateExtras').classList.contains('hidden')) return;
        data[el.name] = el.value;
      });

      // Save intake draft
      const draftRes = await fetch('/api/save-intake', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product: 'llc', answers: data })
      });
      const { draftId } = await draftRes.json();

      // Create checkout session
      const sessionRes = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product: 'llc', draftId })
      });
      const { id } = await sessionRes.json();

      // Redirect to Stripe
      await loadStripe().then(s => s.redirectToCheckout({ sessionId: id }));
    });

    async function loadStripe() {
      if (window.Stripe) return window.Stripe('pk_live_YOUR_PUBLISHABLE_KEY');
      return new Promise((resolve) => {
        const s = document.createElement('script'); s.src = 'https://js.stripe.com/v3/';
        s.onload = () => resolve(window.Stripe('pk_live_YOUR_PUBLISHABLE_KEY'));
        document.head.appendChild(s);
      });
    }
  </script>
</body>
</html>
